# 3.8.6 Выполнение команд на каждом переходе

Предположим, что мы хотим, чтобы робот выполнял одну или несколько функций каждый раз при переходе из одного состояния в другое. Например, возможно, мы хотим, чтобы патрульный робот сканировал людей в каждой комнате, и если он кого-то видит, поздоровался с ним, а затем продолжил.

Этот тип выполнения может быть выполнен с помощью функции обратного вызова перехода. Наш демонстрационный скрипт называется _patrol\_smach\_callback.py_ , расположенный в директории _rbx2\_tasks/nodes_. Большая часть скрипта совпадает со скриптом _patrol\_smach.py_ , описанным ранее, поэтому мы только подчеркнем различия. 

Сначала мы установим обратный вызов перехода на машине состояния следующим образом:

```text
self.sm_patrol.register_transition_cb(self.transition_cb, cb_args=[])
```

Функция _register\_transition\_cb\(\)_ принимает два аргумента: функцию обратного вызова, которую мы хотим выполнить, и список аргументов обратного вызова, который может быть просто пустым списком, как мы использовали здесь. Наша функция обратного вызова, _self.transition\_cb\(\)_, выглядит следующим образом:

```text
def transition_cb(self, userdata, active_states, *cb_args): if
self.rand.randint(0, 3) == 0:
rospy.loginfo("Greetings human!")
rospy.sleep(1)
rospy.loginfo("Is everything OK?")
rospy.sleep(1) else:
rospy.loginfo("Nobody here.")
```

Здесь мы просто притворились, что проверяем на присутствие человека, случайным образом выбирая число от 0 до 3. Если оно окажется равным 0, мы передадим приветствие, в противном случае мы сообщим, что никого нет. Конечно, в реальном приложении вы можете включить код, который сканирует комнату, панорамируя камеру робота, и использует текст-в-речь, чтобы поговорить с кем-нибудь, если он будет обнаружен.

Для проверки скрипта убедитесь, что у вас запущен фальшивый TurtleBot, как и в предыдущих разделах, а также RViz с конфигурационным файлом _nav\_tasks.rviz_ , ****затем запустите скрипт итератора:

```text
$ rosrun rbx2_tasks patrol_smach_callback.py
```

В отличие от предыдущих скриптов, этот скрипт будет работать бесконечно, пока вы не прервете его с помощью Ctrl-C.

