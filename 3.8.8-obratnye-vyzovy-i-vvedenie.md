# 3.8.8 Обратные вызовы и введение

Одной из сильных сторон SMACH является способность определять состояние машины в любой момент времени и устанавливать обратные вызовы при переходе или завершении состояния. Например, если машина данного состояния вытесняется, мы можем захотеть узнать, в каком последнем состоянии она находилась до того, как была прервана. Мы будем использовать эту возможность в следующем разделе, чтобы определить, где продолжать патрулирование после перезарядки. Мы также можем использовать интроспекцию для улучшения процесса отслеживания успешности: вместо того, чтобы просто вести подсчет количества достигнутых путевых точек, мы можем на самом деле записать и ID путевой точки.

Подробную информацию обо всех возможных обратных вызовах можно найти в онлайн-интерфейсе [SMACH API](http://docs.ros.org/jade/api/smach/html/index.html). Обратный вызов, который мы будем использовать чаще всего, выполняется при каждом переходе в определенное состояние в пределах данного государственного аппарата. Сама функция обратного вызова устанавливается с помощью метода [register\_transition\_cb\(\)](http://docs.ros.org/kinetic/api/smach/html/python/smach.sequence.Sequence-class.html) на объекте машины состояния. Например, чтобы зарегистрировать обратный вызов на нашей машине состояний патруля в сценарии patrol\_smach.py, мы будем использовать синтаксис:

```text
self.sm_patrol.register_transition_cb(self.patrol_transition_cb, cb_args=[])
```

Затем мы бы определили функцию _self.patrol\_transition\_cb_ для выполнения любого кода при каждом переходе в состояние:

```text
def patrol_transition_cb(self, userdata, active_states, *cb_args):
Do something awesome with userdata, active_states or cb_args
```

Здесь мы видим, что обратный вызов всегда имеет доступ к userdata, _active\_states_ и любым аргументам обратного вызова, которые также были переданы. В частности, переменная _active\_states_ удерживает текущее состояние машины состояния, и мы будем использовать ее в следующем разделе, чтобы определить, где находился робот, когда он был прерван для подзарядки своей батареи.

